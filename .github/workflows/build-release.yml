name: Build and Release Windows Executable

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.LALC_TOKEN }}
          release-type: simple


  # 构建、打包、上传
  build-and-upload:
    runs-on: windows-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    steps:
      # ---------- 1. 检出 ----------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # ---------- 2. 装工具 ----------
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          cache: true

      - name: Install uv
        run: |
          powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
          echo "$HOME\.cargo\bin" >> $GITHUB_PATH

      # ---------- 3. 后端初始化 ----------
      - name: Backend uv sync
        working-directory: lalc_backend
        run: uv sync

      # ---------- 4. 前端初始化 ----------
      - name: Frontend flutter pub get
        working-directory: lalc_frontend
        run: flutter pub get

      # ---------- 5. 打包 ----------
      - name: Run packup_release.bat
        shell: cmd
        run: packup_release.bat

      # ---------- 6. 生成固定前缀 ----------
      - name: Create fixed header
        id: header
        shell: pwsh
        run: |
          $mirrorChyanLink = "- (推荐，速度快质量好）[已有 Mirror酱 CDK？前往 Mirror酱 高速下载](https://mirrorchyan.com/zh/projects?rid=LALC)"
          $githubLink      = "- (可能会限流)[GitHub 最新 Release 下载](https://github.com/HSLix/LixAssistantLimbusCompany/releases/latest) | [Download the latest release from GitHub](https://github.com/HSLix/LixAssistantLimbusCompany/releases/latest)"
          $quarkLink       = "- （不定时更新）重要版本归档：[夸克网盘](https://pan.quark.cn/s/333d6608dddd) | Record Important Version in [KuakeDrive](https://pan.quark.cn/s/333d6608dddd)."
          $discordLink     = "- [加入 Discord 群聊](https://discord.gg/bVzCuBU4bC) | [Join the discord](https://discord.gg/bVzCuBU4bC)"

          $header = "$mirrorChyanLink`n$githubLink`n$quarkLink`n$discordLink`n`n"
          echo "header<<EOF" >> $env:GITHUB_OUTPUT
          echo $header >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

      # ---------- 7. 更新 Release 正文并上传资产 ----------
      - name: Upload asset & prepend fixed header
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.LALC_TOKEN }}
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          body_path: ${{ steps.header.outputs.header_file }}
          files: lalc.zip
          prerelease: ${{ contains(needs.release-please.outputs.tag_name, 'alpha') ||
                          contains(needs.release-please.outputs.tag_name, 'beta') }}