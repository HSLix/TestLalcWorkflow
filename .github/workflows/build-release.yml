name: Build and Release Windows Executable

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0 (æ³¨æ„æ”¹ä¸ºå°å†™vï¼Œæ›´ç¬¦åˆå¸¸è§„)

jobs:
  build-and-release:
    runs-on: windows-latest  # ä½¿ç”¨ Windows ç¯å¢ƒç¡®ä¿ç”Ÿæˆ .exe æ–‡ä»¶
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²è®°å½•ï¼Œç”¨äºè´¡çŒ®è€…åˆ—è¡¨
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # æŒ‡å®šä½ çš„ Python ç‰ˆæœ¬
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if exist requirements.txt pip install -r requirements.txt
        
    - name: Build with PyInstaller
      run: |
        pyinstaller lalc.spec
        # ç¡®è®¤æ„å»ºç»“æœ
        dir dist
        if not exist "dist\lalc.zip" (
          echo "lalc.zip not found in dist directory!"
          exit 1
        )
        
    - name: Get contributors list
      id: contributors
      run: |
        # è·å–æ‰€æœ‰ä¸é‡å¤çš„è´¡çŒ®è€…åå•ï¼ˆGit æäº¤ä½œè€…ï¼‰
        $contributors = git log --format='%aN' | sort -u | Where-Object { $_ -ne "" } | ForEach-Object { "- $_" }
        $contributors = $contributors -join "`n"
        echo "contributors<<EOF" >> $env:GITHUB_OUTPUT
        echo "$contributors" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Get release notes from tag
      id: release-notes
      run: |
        $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
        $notes = git tag -l --format='%(contents)' $tag
        if (-not $notes) {
          $notes = "No release notes provided."
        }
        echo "notes<<EOF" >> $env:GITHUB_OUTPUT
        echo "$notes" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/lalc.zip
        body: |
          # ğŸ§‘â€ğŸ’» è´¡çŒ®è€…
          ${{ steps.contributors.outputs.contributors }}
          
          # ğŸ“ ç‰ˆæœ¬è¯´æ˜
          ${{ steps.release-notes.outputs.notes }}
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}